<div><app-header-recepcionista></app-header-recepcionista></div>

<div class="membresias-container">
  <!-- Header Mejorado -->
  <div class="header">
    <div class="header-content">
      <h1><i class="fas fa-id-card"></i> Gestión de Membresías de Clientes</h1>
      <p class="header-subtitle">Administra y consulta las membresías activas de los clientes</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="abrirDialogoAsignar()" [disabled]="tipoMembresias.length === 0">
        <i class="fas fa-plus-circle"></i> Asignar Membresía
      </button>
      <button class="btn btn-secondary" (click)="cargarMembresiasPorExpirar()">
        <i class="fas fa-exclamation-triangle"></i> Por Expirar
      </button>
      <button class="btn btn-secondary" (click)="verEstadisticas()">
        <i class="fas fa-chart-bar"></i> Estadísticas
      </button>
      
      <!-- Botón temporal para crear membresías si no existen -->
      <button class="btn btn-warning" (click)="crearMembresiasDePrueba()" *ngIf="tipoMembresias.length === 0">
        <i class="fas fa-vial"></i> Crear Membresías de Prueba
      </button>
    </div>
  </div>

  <!-- Métricas Rápidas -->
  <div class="stats-section">
    <h3><i class="fas fa-chart-line"></i> Resumen de Membresías</h3>
    <div class="stats-container">
      <div class="stats-card">
        <div class="stats-icon total">
          <i class="fas fa-users"></i>
        </div>
        <div class="stats-info">
          <h4>Total Membresías</h4>
          <p class="stats-number">{{ membresias.length }}</p>
        </div>
      </div>
      <div class="stats-card">
        <div class="stats-icon active">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="stats-info">
          <h4>Activas</h4>
          <p class="stats-number">{{ calcularTotalActivas() }}</p>
        </div>
      </div>
      <div class="stats-card">
        <div class="stats-icon inactive">
          <i class="fas fa-clock"></i>
        </div>
        <div class="stats-info">
          <h4>Por Expirar</h4>
          <p class="stats-number">{{ calcularPorExpirar() }}</p>
        </div>
      </div>
      <div class="stats-card">
        <div class="stats-icon warning">
          <i class="fas fa-sync-alt"></i>
        </div>
        <div class="stats-info">
          <h4>Tasa Renovación</h4>
          <p class="stats-number">{{ calcularTasaRenovacion() }}%</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtros Mejorados -->
  <div class="filters-card">
    <div class="filters-header">
      <h3><i class="fas fa-filter me-2"></i>Filtros de Búsqueda</h3>
    </div>
    <div class="filters-content">
      <div class="filters-grid">
        <div class="filter-group full-width">
          <label class="filter-label">
            <i class="fas fa-search"></i> Buscar
          </label>
          <input 
            type="text" 
            class="filter-input" 
            [(ngModel)]="filtro" 
            (input)="aplicarFiltro()"
            placeholder="Buscar por folio, tipo o estatus...">
        </div>
      </div>
      
      <div class="filters-actions">
        <button class="btn btn-secondary" (click)="limpiarFiltro()">
          <i class="fas fa-times me-1"></i> Limpiar Filtros
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner Mejorado -->
  <div *ngIf="loading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Cargando membresías...</p>
    <div class="loading-dots">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <!-- Lista de Membresías Mejorada -->
  <div *ngIf="!loading" class="actividades-section">
    <div class="section-header">
      <h2><i class="fas fa-clipboard-list"></i> Lista de Membresías</h2>
      <span class="activities-count">{{ membresiasFiltradas.length }} membresía{{ membresiasFiltradas.length !== 1 ? 's' : '' }}</span>
    </div>

    <div class="actividades-list" [class.scrollable]="membresiasFiltradas.length > 3">
      <div *ngIf="membresiasFiltradas.length === 0" class="no-activities">
        <div class="no-activities-icon">
          <i class="fas fa-id-card"></i>
        </div>
        <h3>No se encontraron membresías</h3>
        <p *ngIf="filtro">
          No hay membresías que coincidan con "{{filtro}}"
        </p>
        <p *ngIf="!filtro && membresias.length === 0">
          No hay membresías activas registradas en el sistema.
          <br><strong>Para comenzar, asigna una membresía a un cliente.</strong>
        </p>
        <p *ngIf="!filtro && membresias.length > 0">
          Todas las membresías están filtradas. 
        </p>
        <div class="action-buttons">
          <button class="btn btn-primary" (click)="abrirDialogoAsignar()" [disabled]="tipoMembresias.length === 0">
            <i class="fas fa-plus-circle"></i> Asignar Primera Membresía
          </button>
          <button class="btn btn-secondary" (click)="limpiarFiltro()" *ngIf="filtro">
            <i class="fas fa-times"></i> Limpiar Filtro
          </button>
        </div>
      </div>

      <div *ngFor="let membresia of membresiasFiltradas; let i = index" class="actividad-card" [style.animation-delay]="i * 0.1 + 's'">
        <div class="actividad-image">
          <div class="image-overlay">
            <span class="image-badge" [class]="getEstatusBadgeClass(membresia)">
              <i class="fas" [class.fa-check-circle]="membresia.estatus === 'Activa'" 
                          [class.fa-clock]="membresia.estatus === 'Inactiva'"
                          [class.fa-exclamation-triangle]="membresia.estatus === 'Expirada'"
                          [class.fa-times-circle]="membresia.estatus === 'Cancelada'"></i>
              {{ membresia.estatus }}
            </span>
          </div>
        </div>
        
        <div class="actividad-content">
          <div class="actividad-header">
            <h4>Cliente: {{ membresia.folio_cliente }}</h4>
            <span [class]="'estatus-badge ' + getTipoMembresiaClass(membresia)">
              <i class="fas fa-star"></i> {{ obtenerEtiquetaMembresia(membresia.id_membresia) }}
            </span>
          </div>
          
          <div class="actividad-info">
            <div class="info-grid">
              <div class="info-item">
                <i class="fas fa-calendar-day"></i>
                <div class="info-content">
                  <span class="info-label">Fecha Inicio</span>
                  <span class="info-value">{{ formatearFecha(membresia.fecha_inicio) }}</span>
                </div>
              </div>
              
              <div class="info-item">
                <i class="fas fa-calendar-check"></i>
                <div class="info-content">
                  <span class="info-label">Fecha Fin</span>
                  <span class="info-value">{{ formatearFecha(membresia.fecha_fin) }}</span>
                </div>
              </div>
              
              <div class="info-item">
                <i class="fas fa-id-card"></i>
                <div class="info-content">
                  <span class="info-label">Tipo Membresía</span>
                  <span class="info-value">{{ obtenerEtiquetaMembresia(membresia.id_membresia) }}</span>
                </div>
              </div>
              
              <div class="info-item">
                <i class="fas fa-info-circle"></i>
                <div class="info-content">
                  <span class="info-label">Estatus</span>
                  <span class="info-value" [style.color]="getEstatusColor(membresia.estatus)">
                    {{ membresia.estatus }}
                  </span>
                </div>
              </div>
            </div>
            
            <div class="info-item descripcion">
              <i class="fas fa-history"></i>
              <div class="info-content">
                <span class="info-label">Registro</span>
                <span class="info-value">Registrada el {{ formatearFecha(membresia.fecha_registro) }}</span>
              </div>
            </div>
          </div>

          <div class="actividad-actions">
            <button 
              class="btn btn-sm btn-primary"
              (click)="renovarMembresia(membresia)"
              title="Renovar membresía">
              <i class="fas fa-sync-alt"></i> Renovar
            </button>
            
            <button 
              class="btn btn-sm btn-warning"
              (click)="verificarAcceso(membresia)"
              title="Verificar acceso">
              <i class="fas fa-check-circle"></i> Verificar Acceso
            </button>
            
            <button 
              class="btn btn-sm btn-info"
              (click)="verHistorial(membresia)"
              title="Ver historial">
              <i class="fas fa-history"></i> Historial
            </button>
            
            <button 
              class="btn btn-sm btn-danger"
              (click)="cancelarMembresia(membresia)"
              title="Cancelar membresía"
              [disabled]="membresia.estatus === 'Cancelada'">
              <i class="fas fa-times-circle"></i> Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Historial CORREGIDO - DENTRO del contenedor principal -->
  <div *ngIf="showHistorialModal" class="form-container historial-modal">
    <div class="form-card historial-card" style="max-width: 900px;">
      <div class="form-header historial-modal-header">
        <h3><i class="fas fa-history"></i> Historial de Membresías - {{ clienteHistorial }}</h3>
        <button class="btn-close" (click)="cerrarModalHistorial()">×</button>
      </div>
      
      <div class="historial-content">
        
        <!-- Loading -->
        <div *ngIf="loadingHistorial" class="loading-spinner historial-loading">
          <div class="spinner"></div>
          <p>Cargando historial...</p>
        </div>
        
        <!-- Lista de historial -->
        <div *ngIf="!loadingHistorial" class="historial-list">
          <div *ngFor="let item of historialData; let i = index" 
               class="historial-item" 
               [style.animation-delay]="i * 0.1 + 's'">
            
            <div class="historial-item-header">
              <div class="historial-tipo">
                <strong>{{ obtenerEtiquetaMembresia(item.id_membresia || item.membresia?.idMembresia) }}</strong>
              </div>
              <span class="estatus-badge historial-badge" [class]="obtenerClaseEstatus(item.estatus)">
                <i class="fas" [class.fa-check-circle]="item.estatus === 'Activa'" 
                            [class.fa-pause-circle]="item.estatus === 'Inactiva'"
                            [class.fa-times-circle]="item.estatus === 'Cancelada'"
                            [class.fa-clock]="item.estatus === 'Expirada'"></i>
                {{ item.estatus }}
              </span>
            </div>
            
            <div class="historial-details">
              <div class="historial-date">
                <i class="fas fa-calendar-alt"></i>
                {{ formatearFecha(item.fecha_inicio || item.fechaInicio) }} - 
                {{ formatearFecha(item.fecha_fin || item.fechaFin) }}
              </div>
              
              <div class="historial-meta">
                <span class="historial-meta-item">
                  <i class="fas fa-calendar-plus"></i>
                  Registro: {{ formatearFecha(item.fecha_registro || item.fechaRegistro) }}
                </span>
                <span class="historial-meta-item" *ngIf="item.fecha_actualizacion || item.fechaActualizacion">
                  <i class="fas fa-edit"></i>
                  Actualizado: {{ formatearFecha(item.fecha_actualizacion || item.fechaActualizacion) }}
                </span>
              </div>
            </div>
          </div>
          
          <!-- Sin datos -->
          <div *ngIf="historialData.length === 0" class="no-data historial-no-data">
            <i class="fas fa-inbox"></i>
            <p>No hay historial de membresías para este cliente</p>
          </div>
        </div>
        
        <!-- Resumen -->
        <div *ngIf="!loadingHistorial && historialData.length > 0" class="historial-summary">
          <div class="summary-item">
            <strong>Total: </strong>{{ historialData.length }} membresía(s)
          </div>
          <div class="summary-item">
            <strong>Activas: </strong>{{ contarActivas() }}
          </div>
          <div class="summary-item">
            <strong>Históricas: </strong>{{ contarHistoricas() }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Diálogo para asignar membresía -->
  <div *ngIf="showAsignarDialog" class="form-container">
    <div class="form-card">
      <div class="form-header">
        <h3><i class="fas fa-id-card"></i> Asignar Nueva Membresía</h3>
        <button class="btn-close" (click)="showAsignarDialog = false" title="Cancelar">
          <span class="close-icon">×</span>
        </button>
      </div>
      
      <form (ngSubmit)="asignarMembresia()" #asignarForm="ngForm" class="payment-form">
        <div class="form-group full-width">
          <label>
            <i class="fas fa-user"></i> Folio Cliente *
          </label>
          <input 
            type="text" 
            class="form-control"
            [(ngModel)]="asignarFormData.folioCliente" 
            name="folioCliente" 
            required
            placeholder="Ingresa el folio del cliente (ej: CLI001)">
          <small *ngIf="asignarForm.submitted && !asignarFormData.folioCliente" class="error-text">
            <i class="fas fa-exclamation-triangle"></i> El folio del cliente es requerido
          </small>
        </div>

        <div class="form-group full-width">
          <label>
            <i class="fas fa-crown"></i> Tipo de Membresía *
          </label>
          <select 
            class="form-control"
            [(ngModel)]="asignarFormData.idMembresia" 
            name="idMembresia" 
            required>
            <option value="" disabled selected>-- Selecciona un tipo de membresía --</option>
            <option *ngFor="let tipo of tipoMembresias" [value]="tipo.value">
              {{ tipo.label }}
            </option>
          </select>
          <small *ngIf="asignarForm.submitted && !asignarFormData.idMembresia" class="error-text">
            <i class="fas fa-exclamation-triangle"></i> El tipo de membresía es requerido
          </small>
          
          <!-- Mensaje informativo si no hay membresías -->
          <div *ngIf="tipoMembresias.length === 0" class="form-info warning">
            <i class="fas fa-exclamation-triangle"></i>
            <span>No hay tipos de membresía configurados. Contacta al administrador.</span>
          </div>
        </div>

        <div class="form-group full-width">
          <label>
            <i class="fas fa-calendar-alt"></i> Fecha Inicio *
          </label>
          <input 
            type="date" 
            class="form-control"
            [(ngModel)]="asignarFormData.fechaInicio" 
            name="fechaInicio" 
            required>
          <small *ngIf="asignarForm.submitted && !asignarFormData.fechaInicio" class="error-text">
            <i class="fas fa-exclamation-triangle"></i> La fecha de inicio es requerida
          </small>
        </div>

        <div class="form-info">
          <i class="fas fa-info-circle"></i>
          <span>La membresía se asignará con vigencia según el tipo seleccionado</span>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="showAsignarDialog = false" [disabled]="loading">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="loading || !asignarForm.form.valid || tipoMembresias.length === 0">
            <i class="fas" [class.fa-save]="!loading" [class.fa-spinner]="loading" [class.fa-spin]="loading"></i>
            {{ loading ? 'Asignando...' : 'Asignar Membresía' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Snackbar Mejorado -->
  <div *ngIf="snackbar.show" 
       class="snackbar-overlay"
       [class.snackbar-success]="snackbar.type === 'success'"
       [class.snackbar-error]="snackbar.type === 'error'"
       [class.snackbar-warning]="snackbar.type === 'warning'">
    <div class="snackbar-content">
      <i class="fas" [class.fa-check-circle]="snackbar.type === 'success'" 
                  [class.fa-exclamation-triangle]="snackbar.type === 'error' || snackbar.type === 'warning'"></i>
      <span class="snackbar-message">{{ snackbar.message }}</span>
      <button class="snackbar-close" (click)="cerrarSnackbar()">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
</div>