<div>
  <app-header-admin></app-header-admin>
</div>

<div class="administrador-container">
  @if (mensaje) {
    <div [class]="'alert alert-' + tipoMensaje">
      {{ mensaje }}
    </div>
  }

  <!-- Header Actividades - Estilo similar al ActividadesComponent -->
  <div class="header">
    <!-- Contenedor principal del header -->
    <div class="header-main">
      <!-- Logo o título a la izquierda -->
      <div class="header-brand">
        <h1 class="header-title">
          <i class="fas fa-users-cog"></i>
          Administradores
        </h1>
      </div>
      
      <!-- Barra de búsqueda centrada -->
      <div class="search-bar-header">
        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input
            type="text"
            [(ngModel)]="terminoBusqueda"
            (input)="onBuscarNombreChange()"
            placeholder="Buscar administradores por nombre..."
            class="search-input"
          >
          <button *ngIf="terminoBusqueda" class="btn btn-clear" (click)="terminoBusqueda = ''; aplicarFiltros()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <!-- Botones de acción a la derecha -->
      <div class="header-actions">
        <button class="btn btn-primary" (click)="prepararNuevoAdministrador()" [disabled]="cargando">
          <i class="fas fa-plus-circle"></i> Nuevo Administrador
        </button>
      </div>
    </div>
    
    <!-- Filtros en una fila separada -->
    <div class="header-filters">
      <div class="filters-container">
        <button class="filter-btn active" (click)="limpiarFiltros()">
          <i class="fas fa-list"></i> Todos
        </button>
      </div>
      
      <!-- Contador de administradores -->
      <div class="activities-counter">
        <span class="counter-badge">{{administradoresFiltrados.length}} administrador{{ administradoresFiltrados.length !== 1 ? 'es' : '' }}</span>
      </div>
    </div>
  </div>

  <!-- FILTROS MEJORADOS CON DEBOUNCE -->
  <div class="filtros-section">
    <div class="filtros-row">
      <div class="filtro-group">
        <label><i class="fas fa-user"></i> Apellido Paterno:</label>
        <input type="text" [(ngModel)]="filtroApp" 
               (input)="onFiltroAppChange()" 
               placeholder="Filtrar por apellido paterno..." 
               [disabled]="cargando">
      </div>

      <div class="filtro-group">
        <label><i class="fas fa-user"></i> Apellido Materno:</label>
        <input type="text" [(ngModel)]="filtroApm" 
               (input)="onFiltroApmChange()" 
               placeholder="Filtrar por apellido materno..." 
               [disabled]="cargando">
      </div>

      <button class="btn btn-secondary" (click)="limpiarFiltros()" [disabled]="cargando">
        <i class="fas fa-undo"></i> Limpiar Filtros
      </button>
    </div>
  </div>

  @if (cargando) {
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Cargando administradores...</p>
      <div class="loading-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  }

  @if (!cargando) {
    <div class="administradores-section">
      <div class="section-header">
        <h2><i class="fas fa-clipboard-list"></i> Lista de Administradores</h2>
        <span class="administradores-count">{{ administradoresFiltrados.length }} administrador{{ administradoresFiltrados.length !== 1 ? 'es' : '' }}</span>
      </div>
      
      <div class="table-container">
        <table class="administradores-table">
          <thead>
            <tr>
              <th>Folio</th>
              <th>Nombre Completo</th>
              <th>Apellido Paterno</th>
              <th>Apellido Materno</th>
              <th>Fecha de Registro</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (administrador of administradoresFiltrados; track administrador.folioAdmin) {
              <tr>
                <td class="folio-cell">
                  <strong>{{ administrador.folioAdmin }}</strong>
                </td>
                <td>
                  <div class="administrador-info">
                    <div class="administrador-avatar">
                      <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="administrador-name">
                      {{ administrador.nombreCom }}
                    </div>
                  </div>
                </td>
                <td>{{ administrador.app || '-' }}</td>
                <td>{{ administrador.apm || '-' }}</td>
                <td>
                  <div class="fecha-info">
                    <div>{{ formatearFecha(administrador.fechaRegistro) }}</div>
                    <small class="text-muted">{{ getTiempoRegistro(administrador.fechaRegistro) }}</small>
                  </div>
                </td>
                <td class="acciones">
                  <button class="btn btn-sm btn-info" 
                          (click)="verEstadisticas(administrador)"
                          title="Ver estadísticas">
                    <i class="fas fa-chart-line"></i>
                  </button>
                  
                  <button class="btn btn-sm btn-warning" 
                          (click)="seleccionarAdministrador(administrador)"
                          title="Editar administrador">
                    <i class="fas fa-edit"></i>
                  </button>

                  <button class="btn btn-sm btn-danger" 
                          (click)="eliminarAdministrador(administrador.folioAdmin)"
                          title="Eliminar administrador">
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="6" class="no-data">
                  <div class="no-administradores">
                    <div class="no-administradores-icon">
                      <i class="fas fa-users-cog"></i>
                    </div>
                    <h3>No se encontraron administradores</h3>
                    <p>No hay administradores registrados en el sistema.</p>
                    <button class="btn btn-primary" (click)="prepararNuevoAdministrador()">
                      <i class="fas fa-plus-circle"></i> Crear Primer Administrador
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }

  <!-- FORMULARIO NUEVO ADMINISTRADOR -->
  @if (mostrarFormulario && !modoEdicion) {
    <div class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-user-plus"></i> Nuevo Administrador</h2>
          <button class="btn-close" (click)="cerrarFormulario()" [disabled]="cargando">
            <span class="close-icon">×</span>
          </button>
        </div>

        <form (ngSubmit)="crearAdministrador()" class="modal-body">
          <div class="form-info">
            <p class="folio-info">
              <i class="fas fa-id-card"></i>
              <strong>Folio generado automáticamente:</strong> {{ folioGenerado }}
            </p>
          </div>

          <div class="form-section">
            <h3><i class="fas fa-id-card"></i> Información Personal</h3>
            
            <div class="form-row">
              <div class="form-group full-width">
                <label><i class="fas fa-user"></i> Nombre Completo *</label>
                <input type="text" 
                       [(ngModel)]="nuevoAdministrador.nombreCom" 
                       name="nombreComNuevo" 
                       required
                       [disabled]="cargando"
                       placeholder="Nombre completo del administrador"
                       (input)="validarNombre()">
                @if (nombreInvalido) {
                  <small class="error-text">El nombre completo es requerido</small>
                }
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label><i class="fas fa-user"></i> Apellido Paterno</label>
                <input type="text" 
                       [(ngModel)]="nuevoAdministrador.app" 
                       name="appNuevo"
                       [disabled]="cargando"
                       placeholder="Apellido paterno">
              </div>

              <div class="form-group">
                <label><i class="fas fa-user"></i> Apellido Materno</label>
                <input type="text" 
                       [(ngModel)]="nuevoAdministrador.apm" 
                       name="apmNuevo"
                       [disabled]="cargando"
                       placeholder="Apellido materno">
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" 
                    class="btn btn-secondary" 
                    (click)="cerrarFormulario()"
                    [disabled]="cargando">
              <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="submit" 
                    class="btn btn-primary" 
                    [disabled]="cargando || !nuevoAdministrador.nombreCom.trim()">
              <i class="fas fa-save"></i> {{ cargando ? 'Creando...' : 'Crear Administrador' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- FORMULARIO EDITAR ADMINISTRADOR -->
  @if (mostrarFormulario && modoEdicion) {
    <div class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-user-edit"></i> Editar Administrador</h2>
          <button class="btn-close" (click)="cerrarFormulario()" [disabled]="cargando">
            <span class="close-icon">×</span>
          </button>
        </div>

        <form (ngSubmit)="actualizarAdministrador()" class="modal-body">
          <div class="form-info">
            <p class="folio-info">
              <i class="fas fa-id-card"></i>
              <strong>Folio:</strong> {{ administradorSeleccionado.folioAdmin }}
            </p>
          </div>

          <div class="form-section">
            <h3><i class="fas fa-id-card"></i> Información Personal</h3>
            
            <div class="form-row">
              <div class="form-group full-width">
                <label><i class="fas fa-user"></i> Nombre Completo *</label>
                <input type="text" 
                       [(ngModel)]="administradorSeleccionado.nombreCom" 
                       name="nombreComEdit" 
                       required
                       [disabled]="cargando"
                       placeholder="Nombre completo del administrador">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label><i class="fas fa-user"></i> Apellido Paterno</label>
                <input type="text" 
                       [(ngModel)]="administradorSeleccionado.app" 
                       name="appEdit"
                       [disabled]="cargando"
                       placeholder="Apellido paterno">
              </div>

              <div class="form-group">
                <label><i class="fas fa-user"></i> Apellido Materno</label>
                <input type="text" 
                       [(ngModel)]="administradorSeleccionado.apm" 
                       name="apmEdit"
                       [disabled]="cargando"
                       placeholder="Apellido materno">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label><i class="fas fa-calendar"></i> Fecha de Registro</label>
                <input type="text" 
                       [value]="formatearFecha(administradorSeleccionado.fechaRegistro)" 
                       disabled
                       class="form-control">
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" 
                    class="btn btn-secondary" 
                    (click)="cerrarFormulario()"
                    [disabled]="cargando">
              <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="submit" 
                    class="btn btn-primary" 
                    [disabled]="cargando">
              <i class="fas fa-save"></i> {{ cargando ? 'Actualizando...' : 'Actualizar Administrador' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- MODAL ESTADÍSTICAS -->
  @if (mostrarEstadisticas) {
    <div class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-chart-line"></i> Estadísticas - {{ administradorSeleccionado.nombreCom }}</h2>
          <button class="btn-close" (click)="cerrarFormulario()">
            <span class="close-icon">×</span>
          </button>
        </div>

        <div class="modal-body">
          <div class="estadisticas-grid">
            <div class="estadistica-card">
              <div class="stats-icon total">
                <i class="fas fa-tasks"></i>
              </div>
              <div class="stats-info">
                <h4>Total Gestiones</h4>
                <p class="stats-number">{{ estadisticas.totalGestiones }}</p>
              </div>
            </div>
            <div class="estadistica-card">
              <div class="stats-icon active">
                <i class="fas fa-id-card"></i>
              </div>
              <div class="stats-info">
                <h4>Membresías Activas</h4>
                <p class="stats-number">{{ estadisticas.totalMembresiasActivas }}</p>
              </div>
            </div>
            <div class="estadistica-card">
              <div class="stats-icon inactive">
                <i class="fas fa-users"></i>
              </div>
              <div class="stats-info">
                <h4>Clientes Activos</h4>
                <p class="stats-number">{{ estadisticas.totalClientesActivos }}</p>
              </div>
            </div>
            <div class="estadistica-card">
              <div class="stats-icon total">
                <i class="fas fa-chalkboard-teacher"></i>
              </div>
              <div class="stats-info">
                <h4>Instructores Activos</h4>
                <p class="stats-number">{{ estadisticas.totalInstructoresActivos }}</p>
              </div>
            </div>
            <div class="estadistica-card">
              <div class="stats-icon active">
                <i class="fas fa-user-tie"></i>
              </div>
              <div class="stats-info">
                <h4>Recepcionistas Activos</h4>
                <p class="stats-number">{{ estadisticas.totalRecepcionistasActivos }}</p>
              </div>
            </div>
            <div class="estadistica-card">
              <div class="stats-icon inactive">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <div class="stats-info">
                <h4>Ingresos Hoy</h4>
                <p class="stats-number">${{ estadisticas.ingresosHoy || 0 }}</p>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-primary" (click)="cerrarFormulario()">
              <i class="fas fa-times"></i> Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>