<div>
  <app-header-admin></app-header-admin>
</div>
<div class="instructor-container">
  @if (mensaje) {
    <div [class]="'alert alert-' + tipoMensaje">
      <div class="alert-content">
        <i [class]="tipoMensaje === 'success' ? 'fas fa-check-circle' : 
                    tipoMensaje === 'error' ? 'fas fa-exclamation-circle' : 
                    'fas fa-info-circle'"></i>
        <span>{{ mensaje }}</span>
      </div>
      <button class="alert-close" (click)="mensaje = ''">
        <i class="fas fa-times"></i>
      </button>
    </div>
  }

  <!-- Header Mejorado con Tema Gimnasio -->
  <div class="header">
    <div class="header-content">
      <h1><i class="fas fa-users"></i> Gestión de Clientes</h1>
      <p class="header-subtitle">Administra y organiza los clientes del gimnasio</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="vistaActual = 'crear'" [disabled]="cargando">
        <i class="fas fa-plus-circle"></i> Nuevo Cliente
      </button>
    </div>
  </div>

  <!-- FILTROS MEJORADOS -->
  <div class="filtros-section">
    <div class="filtros-row">
      <div class="filtro-group">
        <label><i class="fas fa-search"></i> Buscar por nombre:</label>
        <input type="text" [(ngModel)]="terminoBusqueda" 
               (keyup.enter)="buscarClientes()" 
               placeholder="Escribe el nombre..." 
               [disabled]="cargando">
      </div>

      <div class="filtro-group">
        <label><i class="fas fa-filter"></i> Estatus:</label>
        <select [(ngModel)]="filtroEstatus" (change)="aplicarFiltros()" [disabled]="cargando">
          <option value="">Todos los estatus</option>
          <option value="Activo">Activo</option>
          <option value="Inactivo">Inactivo</option>
        </select>
      </div>

      <div class="filtro-group">
        <label><i class="fas fa-user"></i> Nombre:</label>
        <input type="text" [(ngModel)]="filtroNombre" 
               (input)="aplicarFiltros()" 
               placeholder="Filtrar por nombre..." 
               [disabled]="cargando">
      </div>

      <div class="filtro-group">
        <button class="btn btn-info" (click)="buscarClientes()" [disabled]="cargando">
          <i class="fas fa-search"></i> Buscar
        </button>
        <button class="btn btn-secondary" (click)="limpiarFiltros()" [disabled]="cargando" style="margin-left: 10px;">
          <i class="fas fa-undo"></i> Limpiar
        </button>
      </div>
    </div>
  </div>

  <!-- Estadísticas Rápidas -->
  <div class="estadisticas">
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fas fa-users"></i>
      </div>
      <div class="stat-content">
        <h3>{{ totalClientes }}</h3>
        <p>Total Clientes</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background: linear-gradient(135deg, #2EC4B6, #34D1BF);">
        <i class="fas fa-user-check"></i>
      </div>
      <div class="stat-content">
        <h3>{{ clientesActivos }}</h3>
        <p>Clientes Activos</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background: linear-gradient(135deg, #FFD166, #FFDF8E);">
        <i class="fas fa-user-clock"></i>
      </div>
      <div class="stat-content">
        <h3>{{ clientesInactivos }}</h3>
        <p>Clientes Inactivos</p>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background: linear-gradient(135deg, #E63946, #EB5669);">
        <i class="fas fa-percentage"></i>
      </div>
      <div class="stat-content">
        <h3>{{ porcentajeActivos | number:'1.0-0' }}%</h3>
        <p>Tasa de Activos</p>
      </div>
    </div>
  </div>

  @if (cargando) {
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Cargando clientes...</p>
      <div class="loading-dots">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  }

  @if (!cargando) {
    <div class="instructores-section">
      <div class="section-header">
        <h2><i class="fas fa-clipboard-list"></i> Lista de Clientes</h2>
        <div class="section-actions">
          <span class="instructores-count">{{ totalClientes }} cliente{{ totalClientes !== 1 ? 's' : '' }}</span>
          <button class="btn btn-success btn-sm" (click)="exportarClientesCSV()" [disabled]="clientesFiltrados.length === 0">
            <i class="fas fa-file-export"></i> Exportar CSV
          </button>
        </div>
      </div>
      
      <div class="table-container">
        <table class="instructores-table">
          <thead>
            <tr>
              <th>Folio</th>
              <th>Nombre Completo</th>
              <th>Contacto</th>
              <th>Información Personal</th>
              <th>Fecha Registro</th>
              <th>Estatus</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (cliente of clientesFiltrados; track cliente.folioCliente) {
              <tr>
                <td><strong>{{ cliente.folioCliente }}</strong></td>
                <td>
                  <div class="instructor-info">
                    <div class="instructor-avatar no-photo">
                      <i class="fas fa-user"></i>
                    </div>
                    <div class="instructor-name">
                      {{ cliente.nombre }}
                    </div>
                  </div>
                </td>
                <td>
                  <div class="contacto-info">
                    <div><i class="fas fa-envelope"></i> {{ cliente.email || 'No especificado' }}</div>
                    <div><i class="fas fa-phone"></i> {{ cliente.telefono || 'No especificado' }}</div>
                  </div>
                </td>
                <td>
                  <div class="personal-info">
                    <div><i class="fas fa-venus-mars"></i> {{ cliente.genero || 'No especificado' }}</div>
                    <div><i class="fas fa-birthday-cake"></i> 
                      {{ cliente.fechaNacimiento ? (getEdad(cliente.fechaNacimiento) + ' años') : 'No especificada' }}
                    </div>
                  </div>
                </td>
                <td>
                  <div class="fecha-info">
                    <div>{{ formatearFecha(cliente.fechaRegistro) }}</div>
                    <small class="text-muted">{{ getTiempoRegistro(cliente.fechaRegistro) }}</small>
                  </div>
                </td>
                <td>
                  <span [class]="'estatus-badge ' + (cliente.estatus === 'Activo' ? 'badge-activo' : 'badge-inactivo')">
                    <i class="fas fa-circle"></i> {{ cliente.estatus }}
                  </span>
                </td>
                <td class="acciones">
                  <button class="btn btn-sm btn-info" 
                          (click)="verDetalles(cliente)"
                          title="Ver detalles">
                    <i class="fas fa-eye"></i> Ver
                  </button>
                  
                  <button class="btn btn-sm btn-warning" 
                          (click)="editarCliente(cliente)"
                          title="Editar cliente">
                    <i class="fas fa-edit"></i> Editar
                  </button>
                  
                  @if (cliente.estatus === 'Activo') {
                    <button class="btn btn-sm btn-danger" 
                            (click)="darDeBajaCliente(cliente.folioCliente)"
                            title="Dar de baja">
                      <i class="fas fa-user-slash"></i> Baja
                    </button>
                  } @else {
                    <button class="btn btn-sm btn-success" 
                            (click)="activarCliente(cliente.folioCliente)"
                            title="Activar cliente">
                      <i class="fas fa-user-check"></i> Activar
                    </button>
                  }
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="7" class="no-data">
                  <div class="no-instructores">
                    <div class="no-instructores-icon">
                      <i class="fas fa-users-slash"></i>
                    </div>
                    <h3>No se encontraron clientes</h3>
                    <p>No hay clientes registrados en el sistema.</p>
                    <button class="btn btn-primary" (click)="vistaActual = 'crear'">
                      <i class="fas fa-plus-circle"></i> Crear Primer Cliente
                    </button>
                    <button class="btn btn-secondary" (click)="generarClientePrueba()" style="margin-left: 10px;">
                      <i class="fas fa-magic"></i> Generar Cliente Prueba
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }

  <!-- FORMULARIO NUEVO CLIENTE -->
  @if (vistaActual === 'crear') {
    <div class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-user-plus"></i> Nuevo Cliente</h2>
          <button class="btn-close" (click)="volverALista()" [disabled]="cargando">
            <span class="close-icon">×</span>
          </button>
        </div>

        <form (ngSubmit)="crearCliente()" class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-user"></i> Nombre Completo *</label>
              <input type="text" 
                     [(ngModel)]="nuevoCliente.nombre" 
                     name="nombre" 
                     required
                     [disabled]="cargando"
                     placeholder="Nombre completo del cliente">
              @if (erroresValidacion['nombre']) {
                <div class="error-text">
                  {{ erroresValidacion['nombre'] }}
                </div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-envelope"></i> Email *</label>
              <input type="email" 
                     [(ngModel)]="emailUsuario" 
                     name="email"
                     [disabled]="cargando"
                     placeholder="correo@ejemplo.com"
                     required>
              @if (erroresValidacion['emailUsuario']) {
                <div class="error-text">
                  {{ erroresValidacion['emailUsuario'] }}
                </div>
              }
            </div>

            <div class="form-group">
              <label><i class="fas fa-phone"></i> Teléfono</label>
              <input type="tel" 
                     [(ngModel)]="nuevoCliente.telefono" 
                     name="telefono"
                     [disabled]="cargando"
                     placeholder="10 dígitos">
              @if (erroresValidacion['telefono']) {
                <div class="error-text">
                  {{ erroresValidacion['telefono'] }}
                </div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-birthday-cake"></i> Fecha de Nacimiento</label>
              <input type="date" 
                     [(ngModel)]="nuevoCliente.fechaNacimiento" 
                     name="fechaNacimiento"
                     [disabled]="cargando">
            </div>

            <div class="form-group">
              <label><i class="fas fa-venus-mars"></i> Género</label>
              <select [(ngModel)]="nuevoCliente.genero" name="genero" [disabled]="cargando" class="form-select">
                <option value="">Seleccionar...</option>
                @for (genero of generos; track genero) {
                  <option [value]="genero">{{ genero }}</option>
                }
              </select>
            </div>
          </div>

          <div class="form-group">
            <label><i class="fas fa-toggle-on"></i> Estatus</label>
            <select [(ngModel)]="nuevoCliente.estatus" name="estatus" [disabled]="cargando" class="form-select">
              @for (estatus of estatusOpciones; track estatus) {
                <option [value]="estatus">{{ estatus }}</option>
              }
            </select>
          </div>

          <div class="modal-actions">
            <button type="button" 
                    class="btn btn-secondary" 
                    (click)="volverALista()"
                    [disabled]="cargando">
              <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="submit" 
                    class="btn btn-primary" 
                    [disabled]="cargando || !nuevoCliente.nombre.trim() || !emailUsuario.trim()">
              <i class="fas fa-save"></i> {{ cargando ? 'Creando...' : 'Crear Cliente' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- VISTA DETALLE DE CLIENTE -->
  @if (vistaActual === 'detalle' && clienteSeleccionado) {
    <div class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-user-circle"></i> Detalles del Cliente</h2>
          <button class="btn-close" (click)="volverALista()">
            <span class="close-icon">×</span>
          </button>
        </div>

        <div class="modal-body">
          <div class="detalle-grid">
            <div class="detalle-section">
              <h3><i class="fas fa-id-card"></i> Información General</h3>
              <div class="info-grid">
                <div class="info-item">
                  <label>Folio:</label>
                  <span>{{ clienteSeleccionado.folioCliente }}</span>
                </div>
                <div class="info-item">
                  <label>Nombre:</label>
                  <span>{{ clienteSeleccionado.nombre }}</span>
                </div>
                <div class="info-item">
                  <label>Estatus:</label>
                  <span [class]="'estatus-badge ' + (clienteSeleccionado.estatus === 'Activo' ? 'badge-activo' : 'badge-inactivo')">
                    {{ clienteSeleccionado.estatus }}
                  </span>
                </div>
                <div class="info-item">
                  <label>Fecha Registro:</label>
                  <span>{{ formatearFecha(clienteSeleccionado.fechaRegistro) }}</span>
                </div>
              </div>
            </div>

            <div class="detalle-section">
              <h3><i class="fas fa-address-book"></i> Información de Contacto</h3>
              <div class="info-grid">
                <div class="info-item">
                  <label>Email:</label>
                  <span>{{ clienteSeleccionado.email || 'No especificado' }}</span>
                </div>
                <div class="info-item">
                  <label>Teléfono:</label>
                  <span>{{ clienteSeleccionado.telefono || 'No especificado' }}</span>
                </div>
              </div>
            </div>

            <div class="detalle-section">
              <h3><i class="fas fa-user"></i> Información Personal</h3>
              <div class="info-grid">
                <div class="info-item">
                  <label>Género:</label>
                  <span>{{ clienteSeleccionado.genero || 'No especificado' }}</span>
                </div>
                <div class="info-item">
                  <label>Fecha Nacimiento:</label>
                  <span>{{ clienteSeleccionado.fechaNacimiento ? formatearFecha(clienteSeleccionado.fechaNacimiento) : 'No especificada' }}</span>
                </div>
                <div class="info-item">
                  <label>Edad:</label>
                  <span>{{ clienteSeleccionado.fechaNacimiento ? (getEdad(clienteSeleccionado.fechaNacimiento) + ' años') : 'No especificada' }}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button class="btn btn-warning" (click)="editarCliente(clienteSeleccionado)">
              <i class="fas fa-edit"></i> Editar Cliente
            </button>
            @if (clienteSeleccionado.estatus === 'Activo') {
              <button class="btn btn-danger" (click)="darDeBajaCliente(clienteSeleccionado.folioCliente)">
                <i class="fas fa-user-slash"></i> Dar de Baja
              </button>
            } @else {
              <button class="btn btn-success" (click)="activarCliente(clienteSeleccionado.folioCliente)">
                <i class="fas fa-user-check"></i> Activar Cliente
              </button>
            }
            <button class="btn btn-info" (click)="obtenerEstadisticas()">
              <i class="fas fa-chart-bar"></i> Ver Estadísticas
            </button>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- FORMULARIO EDITAR CLIENTE -->
  @if (vistaActual === 'editar' && clienteSeleccionado) {
    <div class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fas fa-user-edit"></i> Editar Cliente</h2>
          <button class="btn-close" (click)="volverALista()" [disabled]="cargando">
            <span class="close-icon">×</span>
          </button>
        </div>

        <form (ngSubmit)="actualizarCliente()" class="modal-body">
          <div class="form-info">
            <p class="folio-info">
              <i class="fas fa-id-card"></i>
              <strong>Folio:</strong> {{ clienteSeleccionado.folioCliente }}
            </p>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-user"></i> Nombre Completo *</label>
              <input type="text" 
                     [(ngModel)]="clienteEditado.nombre" 
                     name="nombreEdit" 
                     required
                     [disabled]="cargando"
                     placeholder="Nombre completo del cliente">
              @if (erroresValidacion['nombre']) {
                <div class="error-text">
                  {{ erroresValidacion['nombre'] }}
                </div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-envelope"></i> Email</label>
              <input type="email" 
                     [(ngModel)]="emailUsuario" 
                     name="emailEdit"
                     [disabled]="cargando"
                     placeholder="correo@ejemplo.com">
              @if (erroresValidacion['emailUsuario']) {
                <div class="error-text">
                  {{ erroresValidacion['emailUsuario'] }}
                </div>
              }
            </div>

            <div class="form-group">
              <label><i class="fas fa-phone"></i> Teléfono</label>
              <input type="tel" 
                     [(ngModel)]="clienteEditado.telefono" 
                     name="telefonoEdit"
                     [disabled]="cargando"
                     placeholder="10 dígitos">
              @if (erroresValidacion['telefono']) {
                <div class="error-text">
                  {{ erroresValidacion['telefono'] }}
                </div>
              }
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label><i class="fas fa-birthday-cake"></i> Fecha de Nacimiento</label>
              <input type="date" 
                     [(ngModel)]="clienteEditado.fechaNacimiento" 
                     name="fechaNacimientoEdit"
                     [disabled]="cargando">
            </div>

            <div class="form-group">
              <label><i class="fas fa-venus-mars"></i> Género</label>
              <select [(ngModel)]="clienteEditado.genero" name="generoEdit" [disabled]="cargando" class="form-select">
                <option value="">Seleccionar...</option>
                @for (genero of generos; track genero) {
                  <option [value]="genero">{{ genero }}</option>
                }
              </select>
            </div>
          </div>

          <div class="form-group">
            <label><i class="fas fa-toggle-on"></i> Estatus</label>
            <select [(ngModel)]="clienteEditado.estatus" name="estatusEdit" [disabled]="cargando" class="form-select">
              @for (estatus of estatusOpciones; track estatus) {
                <option [value]="estatus">{{ estatus }}</option>
              }
            </select>
          </div>

          <div class="modal-actions">
            <button type="button" 
                    class="btn btn-secondary" 
                    (click)="volverALista()"
                    [disabled]="cargando">
              <i class="fas fa-times"></i> Cancelar
            </button>
            <button type="submit" 
                    class="btn btn-primary" 
                    [disabled]="cargando">
              <i class="fas fa-save"></i> {{ cargando ? 'Actualizando...' : 'Actualizar Cliente' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>